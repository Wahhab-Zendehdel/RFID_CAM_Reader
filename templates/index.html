<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RFID Label OCR</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #111825;
      --panel2: #0e1622;
      --text: #f5f7fa;
      --muted: #9aa4b2;
      --accent: #2d8cff;
      --danger: #ff4d4d;
      --ok: #22c55e;
      --border: rgba(255, 255, 255, 0.08);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow: hidden;
    }

    .app {
      height: 100vh;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .topbar {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .brand {
      font-weight: 800;
      letter-spacing: 0.2px;
      white-space: nowrap;
    }

    .tabs {
      display: flex;
      gap: 6px;
      padding: 4px;
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 12px;
    }

    .tab-btn {
      appearance: none;
      border: 0;
      background: transparent;
      color: var(--muted);
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: background 120ms ease;
    }

    .tab-btn.active {
      background: rgba(45, 140, 255, 0.18);
      color: var(--text);
    }

    .conn {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
    }

    .dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: var(--danger);
    }

    .dot.ok { background: var(--ok); }

    .content {
      flex: 1 1 auto;
      min-height: 0;
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      overflow: hidden;
    }

    .tab-panel {
      height: 100%;
      display: none;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
    }

    .tab-panel.active {
      display: flex;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      min-height: 0;
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    input[type="text"] {
      flex: 1 1 auto;
      min-width: 160px;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      outline: none;
      font-size: 14px;
    }

    button.primary {
      border: 0;
      padding: 12px 14px;
      border-radius: 12px;
      background: var(--accent);
      color: white;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
    }

    button.primary:disabled {
      opacity: 0.55;
      cursor: default;
    }

    button.secondary {
      border: 1px solid var(--border);
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
    }

    button.secondary.on {
      border-color: rgba(34, 197, 94, 0.6);
      background: rgba(34, 197, 94, 0.18);
    }

    button.secondary:disabled {
      opacity: 0.55;
      cursor: default;
    }

    .hint {
      color: var(--muted);
      font-size: 13px;
    }

    .status {
      min-height: 18px;
      color: var(--muted);
      font-size: 13px;
    }

    .tag-grid {
      flex: 1 1 auto;
      min-height: 0;
      display: flex;
      flex-wrap: wrap;
      align-content: flex-start;
      gap: 8px;
      overflow: hidden; /* no internal scroll; we cap render count */
    }

    .chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.04);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      position: relative;
    }

    .chip .label {
      padding: 2px 6px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.08);
      font-size: 11px;
      color: var(--text);
    }

    .chip .label.missing {
      background: rgba(255, 255, 255, 0.04);
      color: var(--muted);
    }

    .chip .tag-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .chip .inline-input {
      width: 70px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      font-size: 12px;
    }

    .chip .chip-status {
      position: absolute;
      left: 10px;
      right: 10px;
      bottom: -16px;
      color: var(--danger);
      font-size: 11px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .chip button {
      border: 0;
      background: rgba(255, 255, 255, 0.08);
      color: var(--text);
      width: 22px;
      height: 22px;
      border-radius: 999px;
      cursor: pointer;
      line-height: 22px;
      padding: 0;
    }

    .capture-layout {
      flex: 1 1 auto;
      min-height: 0;
      display: grid;
      grid-template-columns: minmax(260px, 0.9fr) minmax(320px, 1.1fr);
      grid-template-rows: auto 1fr;
      gap: 12px;
    }

    .events-panel {
      grid-column: 1 / 3;
    }

    .kv {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 6px 10px;
      font-size: 13px;
    }

    .kv .k { color: var(--muted); }
    .kv .v {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .number {
      margin-top: 10px;
      text-align: center;
      padding: 14px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0, 0, 0, 0.22);
      font-size: clamp(40px, 5vw, 64px);
      font-weight: 900;
      letter-spacing: 4px;
    }

    .alert {
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.04);
      font-weight: 700;
      color: var(--text);
    }

    .alert.ok { border-color: rgba(34, 197, 94, 0.5); background: rgba(34, 197, 94, 0.14); }
    .alert.warn { border-color: rgba(234, 179, 8, 0.5); background: rgba(234, 179, 8, 0.14); }
    .alert.danger { border-color: rgba(239, 68, 68, 0.6); background: rgba(239, 68, 68, 0.16); }
    .alert.muted { color: var(--muted); }

    .images {
      min-height: 0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    .image-box {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    .image-title {
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
    }

    .imgwrap {
      flex: 1 1 auto;
      min-height: 0;
      border-radius: 12px;
      border: 1px dashed var(--border);
      background: rgba(0, 0, 0, 0.18);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      text-align: left;
      padding: 8px 8px;
      border-top: 1px solid var(--border);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    th {
      color: var(--muted);
      font-weight: 700;
      border-top: 0;
    }

    @media (max-width: 980px) {
      .images { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
      .kv { grid-template-columns: 120px 1fr; }
    }

    details.panel {
      padding-top: 6px;
    }
    details summary {
      cursor: pointer;
      font-weight: 700;
      color: var(--text);
      list-style: none;
      outline: none;
      margin-bottom: 6px;
    }
    details summary::-webkit-details-marker { display: none; }
    details .kv { margin-top: 4px; }
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">RFID Label OCR</div>

      <nav class="tabs" aria-label="Tabs">
        <button class="tab-btn active" data-tab="tags" type="button">Approved Tags</button>
        <button class="tab-btn" data-tab="capture" type="button">RFID Capture</button>
      </nav>

      <div class="conn" id="conn">
        <span class="dot" id="conn-dot"></span>
        <span id="conn-text">RFID: ...</span>
      </div>
    </header>

    <main class="content">
      <section class="tab-panel active" id="tab-tags">
        <div class="panel">
          <div class="row">
            <input id="tag-input" type="text" placeholder="Enter EPC/UID (hex) ..." autocomplete="off" />
            <input id="tag-label-input" type="text" placeholder="5-digit label (e.g., 12345)" maxlength="5" autocomplete="off" />
            <button class="primary" id="add-tag-btn" type="button">Add Tag</button>
            <button class="secondary" id="listen-btn" type="button">Listening: OFF</button>
          </div>
          <div class="status" id="tags-status"></div>
          <div class="hint" id="tags-meta">Approved tags: 0</div>
        </div>

        <div class="panel" style="flex: 1 1 auto; min-height: 0;">
          <div class="hint" style="margin-bottom: 10px;">Approved tag list (stored in <code>approved_tags.json</code>)</div>
          <div class="tag-grid" id="tags"></div>
        </div>
      </section>

      <section class="tab-panel" id="tab-capture">
        <div class="capture-layout">
          <div class="panel">
            <div class="hint" id="approved-count">Approved tags: 0</div>
            <div class="kv" style="margin-top: 10px;">
              <div class="k">Last RFID tag</div><div class="v" id="last-tag">-</div>
              <div class="k">Approved</div><div class="v" id="last-approved">-</div>
              <div class="k">For tag</div><div class="v" id="cap-tag">-</div>
              <div class="k">Expected</div><div class="v" id="cap-expected">-</div>
              <div class="k">Observed</div><div class="v" id="cap-observed">-</div>
              <div class="k">Match status</div><div class="v" id="cap-match">-</div>
              <div class="k">Attempt</div><div class="v" id="cap-attempt">0 / -</div>
              <div class="k">Message</div><div class="v" id="cap-msg">-</div>
            </div>

            <div class="alert muted" id="cap-banner" aria-live="polite">Waiting for approved RFID tag...</div>
            <div class="number" id="cap-number">-----</div>
            <div class="status" id="cap-sub">Waiting for approved RFID tag...</div>
            <div class="row" style="margin-top: 6px;">
              <button class="primary" id="submit-btn" type="button" disabled>Submit capture</button>
              <div class="hint" id="submit-status">Capture must succeed before submit.</div>
            </div>
          </div>

          <div class="panel">
            <div class="images" style="margin-top: 4px;">
              <div class="image-box">
                <div class="image-title" id="title-original">Original (outline)</div>
                <div class="imgwrap"><img id="img-original" alt="Original frame" /></div>
              </div>
              <div class="image-box">
                <div class="image-title" id="title-paper">Warped paper</div>
                <div class="imgwrap"><img id="img-paper" alt="Warped paper" /></div>
              </div>
              <div class="image-box">
                <div class="image-title" id="title-secondary">Secondary camera</div>
                <div class="imgwrap"><img id="img-secondary" alt="Secondary camera frame" /></div>
              </div>
            </div>

            <details class="panel" style="margin-top: 12px;">
              <summary>Show details</summary>
              <div class="kv">
                <div class="k">Queue</div><div class="v" id="queue-size">0</div>
                <div class="k">Capture</div><div class="v" id="cap-state">idle</div>
                <div class="k">Attempt reset</div><div class="v" id="cap-attempt-reset">-</div>
                <div class="k">Secondary mode</div><div class="v" id="cap-secondary-mode">-</div>
              </div>
            </details>
          </div>

          <div class="panel events-panel">
            <div class="hint" style="margin-bottom: 8px;">Recent events</div>
            <table>
              <thead>
                <tr>
                  <th style="width: 90px;">Type</th>
                  <th style="width: 120px;">Time (UTC)</th>
                  <th>Tag / Info</th>
                </tr>
              </thead>
              <tbody id="events"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const tabButtons = Array.from(document.querySelectorAll(".tab-btn"));
    const tabPanels = {
      tags: document.getElementById("tab-tags"),
      capture: document.getElementById("tab-capture"),
    };

    const connDot = document.getElementById("conn-dot");
    const connText = document.getElementById("conn-text");

    const tagInput = document.getElementById("tag-input");
    const tagLabelInput = document.getElementById("tag-label-input");
    const addTagBtn = document.getElementById("add-tag-btn");
    const listenBtn = document.getElementById("listen-btn");
    const tagsStatus = document.getElementById("tags-status");
    const tagsMeta = document.getElementById("tags-meta");
    const tagsContainer = document.getElementById("tags");

    const approvedCount = document.getElementById("approved-count");
    const lastTag = document.getElementById("last-tag");
    const lastApproved = document.getElementById("last-approved");
    const queueSize = document.getElementById("queue-size");
    const capState = document.getElementById("cap-state");
    const capTag = document.getElementById("cap-tag");
    const capAttempt = document.getElementById("cap-attempt");
    const capAttemptReset = document.getElementById("cap-attempt-reset");
    const capSecondaryMode = document.getElementById("cap-secondary-mode");
    const capExpected = document.getElementById("cap-expected");
    const capObserved = document.getElementById("cap-observed");
    const capMatch = document.getElementById("cap-match");
    const capMsg = document.getElementById("cap-msg");
    const capNumber = document.getElementById("cap-number");
    const capBanner = document.getElementById("cap-banner");
    const capSub = document.getElementById("cap-sub");
    const submitBtn = document.getElementById("submit-btn");
    const submitStatus = document.getElementById("submit-status");
    const imgOriginal = document.getElementById("img-original");
    const imgPaper = document.getElementById("img-paper");
    const imgSecondary = document.getElementById("img-secondary");
    const titleOriginal = document.getElementById("title-original");
    const titlePaper = document.getElementById("title-paper");
    const titleSecondary = document.getElementById("title-secondary");
    const eventsBody = document.getElementById("events");

    let activeTab = "tags";
    let pollInFlight = false;
    let listenEnabled = false;
    let lastScannedTime = Date.now() / 1000;
    let lastListenedTag = "";
    let lastListenTs = 0;
    const LISTEN_DEBOUNCE_SECONDS = 1.0;

    function setActiveTab(name) {
      activeTab = name;
      tabButtons.forEach((b) => b.classList.toggle("active", b.dataset.tab === name));
      Object.entries(tabPanels).forEach(([key, el]) => el.classList.toggle("active", key === name));
      if (name !== "tags") setListening(false);
    }

    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => setActiveTab(btn.dataset.tab));
    });

    function setListening(enabled) {
      listenEnabled = !!enabled;
      listenBtn.classList.toggle("on", listenEnabled);
      listenBtn.textContent = listenEnabled ? "Listening: ON" : "Listening: OFF";
      lastScannedTime = listenEnabled ? Date.now() / 1000 : 0;
      lastListenedTag = "";
      lastListenTs = 0;
      if (listenEnabled) {
        tagsStatus.textContent = "Listening... present a tag to the reader.";
      }
    }

    listenBtn.addEventListener("click", () => {
      setListening(!listenEnabled);
    });

    async function fetchJson(url, options) {
      const resp = await fetch(url, options);
      const data = await resp.json().catch(() => null);
      if (!resp.ok) {
        const msg = data && data.message ? data.message : resp.statusText;
        throw new Error(msg);
      }
      return data;
    }

    function extractTagEntries(data) {
      const labelMaps = {};
      if (data && typeof data === "object") {
        Object.assign(labelMaps, data.tag_labels || {});
        Object.assign(labelMaps, data.tag_to_label || {});
      }

      let tagsRaw = [];
      if (Array.isArray(data)) {
        tagsRaw = data;
      } else if (Array.isArray(data?.tags)) {
        tagsRaw = data.tags;
      } else if (Array.isArray(data?.entries)) {
        tagsRaw = data.entries;
      } else if (Array.isArray((data || {}).tags?.tags)) {
        tagsRaw = data.tags.tags;
      } else if (labelMaps && Object.keys(labelMaps).length > 0) {
        tagsRaw = Object.keys(labelMaps);
      }

      const entries = [];
      for (const item of tagsRaw) {
        if (typeof item === "string") {
          entries.push({ tag: item, label: labelMaps[item] || "" });
        } else if (item && typeof item === "object") {
          const t = item.tag || item.id || item.tag_id;
          if (!t) continue;
          entries.push({ tag: t, label: item.label || labelMaps[t] || "" });
        }
      }

      // ensure labels from map included even if tag list empty
      for (const [t, lbl] of Object.entries(labelMaps)) {
        const exists = entries.some((e) => e.tag === t);
        if (!exists) entries.push({ tag: t, label: lbl });
      }

      const uniq = [];
      const seen = new Set();
      for (const e of entries) {
        if (seen.has(e.tag)) continue;
        seen.add(e.tag);
        uniq.push(e);
      }
      return uniq;
    }

    function renderTags(resp) {
      const entries = extractTagEntries(resp);
      const MAX_RENDER = 50;
      const shown = entries.slice(0, MAX_RENDER);
      tagsContainer.innerHTML = "";

      for (const entry of shown) {
        const tag = entry.tag;
        const label = entry.label || "";
        const chip = document.createElement("div");
        chip.className = "chip";

        const text = document.createElement("span");
        text.textContent = tag;
        chip.appendChild(text);

        const labelSpan = document.createElement("span");
        labelSpan.className = "label" + (label ? "" : " missing");
        labelSpan.textContent = label || "No label";
        chip.appendChild(labelSpan);

        const inlineInput = document.createElement("input");
        inlineInput.className = "inline-input";
        inlineInput.type = "text";
        inlineInput.maxLength = 5;
        inlineInput.placeholder = "12345";
        inlineInput.value = label;

        const saveBtn = document.createElement("button");
        saveBtn.type = "button";
        saveBtn.textContent = "ðŸ’¾";
        saveBtn.title = "Save label";

        const del = document.createElement("button");
        del.type = "button";
        del.textContent = "x";
        del.title = "Remove";

        const statusSpan = document.createElement("div");
        statusSpan.className = "chip-status";
        statusSpan.textContent = "";

        async function saveLabel() {
          const val = inlineInput.value.trim();
          if (!/^\d{5}$/.test(val)) {
            statusSpan.textContent = "Label must be 5 digits";
            return;
          }
          statusSpan.textContent = "";
          saveBtn.disabled = true;
          inlineInput.disabled = true;
          try {
            await fetchJson(`/api/tags/${encodeURIComponent(tag)}/label`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ label: val }),
            });
            await refreshTags();
          } catch (e) {
            statusSpan.textContent = String(e.message || e);
          } finally {
            saveBtn.disabled = false;
            inlineInput.disabled = false;
          }
        }

        saveBtn.addEventListener("click", saveLabel);
        inlineInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") saveLabel();
        });

        del.addEventListener("click", async () => {
          try {
            await fetchJson("/api/tags/" + encodeURIComponent(tag), { method: "DELETE" });
            await refreshTags();
          } catch (e) {
            tagsStatus.textContent = String(e.message || e);
          }
        });

        const actions = document.createElement("div");
        actions.className = "tag-actions";
        actions.appendChild(inlineInput);
        actions.appendChild(saveBtn);
        actions.appendChild(del);

        chip.appendChild(actions);
        chip.appendChild(statusSpan);
        tagsContainer.appendChild(chip);
      }

      const extra = entries.length > MAX_RENDER ? ` (showing ${MAX_RENDER} of ${entries.length})` : "";
      tagsMeta.textContent = `Approved tags: ${entries.length}${extra}`;
    }

    async function refreshTags() {
      try {
        const data = await fetchJson("/api/tags");
        renderTags(data);
      } catch (e) {
        tagsStatus.textContent = String(e.message || e);
      }
    }

    async function addTag() {
      const tag = tagInput.value.trim();
      const label = tagLabelInput.value.trim();
      if (!tag) return;
      if (label && !/^\d{5}$/.test(label)) {
        tagsStatus.textContent = "Label must be exactly 5 digits.";
        return;
      }
      addTagBtn.disabled = true;
      tagsStatus.textContent = "";
      try {
        await fetchJson("/api/tags", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(label ? { tag, label } : { tag }),
        });
        tagInput.value = "";
        tagLabelInput.value = "";
        await refreshTags();
      } catch (e) {
        tagsStatus.textContent = String(e.message || e);
      } finally {
        addTagBtn.disabled = false;
      }
    }

    addTagBtn.addEventListener("click", addTag);
    tagInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") addTag();
    });
    tagLabelInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") addTag();
    });

    async function submitCapture() {
      submitBtn.disabled = true;
      submitStatus.textContent = "Submitting...";
      try {
        const resp = await fetchJson("/api/capture/submit", { method: "POST" });
        const saved = resp.saved || {};
        const files = saved.files || {};
        const path = files.json || "";
        const prefix = saved.prefix || "";
        if (path) submitStatus.textContent = `Saved: ${path}`;
        else if (prefix) submitStatus.textContent = `Submitted (${prefix})`;
        else submitStatus.textContent = "Submitted.";
      } catch (e) {
        submitStatus.textContent = `Submit failed: ${String(e.message || e)}`;
      } finally {
        // button state is refreshed by pollStatus
      }
    }

    submitBtn.addEventListener("click", submitCapture);

    function setConn(connected, enabled, msg) {
      connDot.classList.toggle("ok", !!connected);
      connText.textContent = enabled ? msg : "RFID: disabled (set rfid.host in config.json)";
    }

    function renderEvents(events) {
      const rows = (events || []).slice(-6).reverse();
      eventsBody.innerHTML = "";
      for (const ev of rows) {
        const tr = document.createElement("tr");
        const tdType = document.createElement("td");
        const tdTime = document.createElement("td");
        const tdInfo = document.createElement("td");

        tdType.textContent = ev.type || "-";
        tdTime.textContent = (ev.time_iso || "").replace("T", " ").replace("Z", "");

        if (ev.type === "rfid") {
          tdInfo.textContent = `${ev.tag || ""}${ev.approved ? " (approved)" : " (not approved)"}`;
        } else if (ev.type === "number") {
          tdInfo.textContent = `${ev.tag || ""} -> ${ev.number || ""} (attempt ${ev.attempt || 0})`;
        } else if (ev.type === "timeout") {
          tdInfo.textContent = `${ev.tag || ""} (timeout, attempt ${ev.attempt || 0})`;
        } else if (ev.type === "submitted") {
          const loc = ev.path ? `saved ${ev.path}` : "submitted";
          tdInfo.textContent = `${ev.tag || ""} -> ${ev.number || ""} ${loc}`;
        } else if (ev.type === "cooldown") {
          tdInfo.textContent = `${ev.tag || ""} cooling until ${ev.cooldown_until_iso || ""}`;
        } else if (ev.type === "blocked") {
          tdInfo.textContent = `${ev.tag || ""} blocked (${ev.reason || "awaiting submit"})`;
        } else if (ev.type === "mismatch") {
          tdInfo.textContent = `âš  ${ev.tag || ""} expected ${ev.expected_number || "-"} observed ${ev.observed_number || "-"} (att ${ev.attempt || 0})`;
          tdType.style.color = "var(--danger)";
          tdInfo.style.color = "var(--danger)";
        } else if (ev.type === "missing_label") {
          tdInfo.textContent = `âš  ${ev.tag || ""} has no label (att ${ev.attempt || 0})`;
          tdType.style.color = "var(--muted)";
        } else if (ev.type === "ocr_failed") {
          tdInfo.textContent = `${ev.tag || ""} OCR failed (att ${ev.attempt || 0})`;
        } else if (ev.type === "no_paper") {
          tdInfo.textContent = `${ev.tag || ""} no paper (att ${ev.attempt || 0})`;
        } else {
          tdInfo.textContent = ev.tag || "";
        }

        tr.appendChild(tdType);
        tr.appendChild(tdTime);
        tr.appendChild(tdInfo);
        eventsBody.appendChild(tr);
      }
      if (rows.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = '<td colspan="3" style="color: var(--muted); border-top: 0;">No events yet.</td>';
        eventsBody.appendChild(tr);
      }
    }

    async function pollStatus() {
      if (pollInFlight) return;
      pollInFlight = true;
      try {
        const includeImages = activeTab === "capture";
        const data = await fetchJson("/api/status?include_images=" + (includeImages ? "1" : "0"));

        const r = data.rfid || {};
        const c = data.capture || {};

        approvedCount.textContent = `Approved tags: ${data.approved_tags_count || 0}`;

        if (!r.enabled) {
          setConn(false, false, "");
          listenBtn.disabled = true;
          if (listenEnabled) setListening(false);
        } else if (r.connected) {
          setConn(true, true, `RFID: connected (${r.host}:${r.port})`);
          listenBtn.disabled = false;
        } else {
          setConn(false, true, `RFID: disconnected (${r.host}:${r.port})`);
          listenBtn.disabled = false;
        }

        lastTag.textContent = r.last_tag || "-";
        lastApproved.textContent = r.last_tag ? (r.last_tag_approved ? "YES" : "NO") : "-";
        queueSize.textContent = String(r.queue_size ?? 0);

        capState.textContent = c.state || "idle";
        capTag.textContent = c.tag || "-";
        const attempt = Number(c.attempt ?? 0);
        const maxAttempts = Number(c.max_attempts ?? 0) || "-";
        capAttempt.textContent = `${attempt} / ${maxAttempts}`;
        capAttemptReset.textContent = c.attempt_reset_mode || "-";
        capSecondaryMode.textContent = c.secondary_snapshot_mode || "-";

        const expected = c.expected_number || "";
        const observed = c.observed_number || c.number || "";
        capExpected.textContent = expected || "-";
        capObserved.textContent = observed || "-";
        capMsg.textContent = c.message || "-";
        capNumber.textContent = observed ? observed : "-----";

        let matchStatus = "-";
        let bannerText = "Waiting for approved RFID tag...";
        let bannerClass = "muted";
        const secMsg = c.secondary_message || "";
        const state = c.state || "idle";
        const mismatch = !!c.mismatch;
        const mismatchReason = c.mismatch_reason || "";
        const mismatchMessage = c.mismatch_message || c.message || "";

        if (state === "matched" || (state === "awaiting_submit" && !mismatch && expected && observed && expected === observed)) {
          matchStatus = "MATCH";
          bannerText = "MATCH â€” numbers align";
          bannerClass = "ok";
        } else if (state === "mismatch" || mismatch) {
          matchStatus = "MISMATCH";
          bannerText = mismatchMessage || (expected ? `MISMATCH â€” Expected ${expected} but OCR read ${observed || "-"}` : "MISMATCH");
          bannerClass = "danger";
        } else if (state === "missing_label") {
          matchStatus = "MISSING LABEL";
          bannerText = "MISSING LABEL â€” This tag has no assigned 5-digit label";
          bannerClass = "warn";
        } else if (state === "no_paper") {
          matchStatus = "NO PAPER";
          bannerText = "NO PAPER â€” Paper not detected in this frame";
          bannerClass = "muted";
        } else if (state === "ocr_failed") {
          matchStatus = "OCR FAILED";
          bannerText = "OCR FAILED â€” No 5-digit number found";
          bannerClass = "warn";
        } else if (state === "failed") {
          matchStatus = "FAILED";
          bannerText = mismatchMessage || "Capture failed";
          bannerClass = "danger";
        } else if (state === "awaiting_submit") {
          matchStatus = "AWAITING SUBMIT";
          bannerText = "Captured digits. Submit required.";
          bannerClass = "ok";
        } else if (state === "running") {
          matchStatus = "CAPTURING";
          bannerText = "Capturing...";
          bannerClass = "muted";
        } else if (state === "submitted") {
          matchStatus = "SUBMITTED";
          bannerText = "Submitted. Ready for next tag.";
          bannerClass = "ok";
        }

        capMatch.textContent = matchStatus;
        capBanner.textContent = bannerText + (secMsg ? ` Secondary: ${secMsg}` : "");
        capBanner.className = `alert ${bannerClass}`;

        if (state === "running") capSub.textContent = "Capturing single frame...";
        else if (state === "awaiting_submit") capSub.textContent = "Captured digits. Submit required." + (secMsg ? ` Secondary: ${secMsg}` : "");
        else if (state === "submitted") capSub.textContent = "Submitted. Ready for next tag." + (secMsg ? ` Secondary: ${secMsg}` : "");
        else if (state === "success") capSub.textContent = "Done.";
        else if (state === "failed" || state === "mismatch" || state === "missing_label" || state === "ocr_failed" || state === "no_paper") capSub.textContent = mismatchMessage || c.message || "Failed.";
        else capSub.textContent = "Waiting for approved RFID tag...";

        const awaitingSubmit = !!c.awaiting_submit;
        const backendCanSubmit = typeof c.can_submit === "boolean" ? c.can_submit : null;
        const allowSubmitRule = awaitingSubmit && !mismatch && (!!expected || backendCanSubmit === true);
        const submitAllowed = backendCanSubmit !== null ? backendCanSubmit : allowSubmitRule;
        submitBtn.disabled = !submitAllowed;

        const savedPath = c.submitted_path || "";
        const prefixHint = c.submitted_prefix ? `${c.submitted_prefix}.json` : "";
        if (submitAllowed && awaitingSubmit) {
          submitStatus.textContent = "Ready to submit captured data.";
        } else if (awaitingSubmit && !submitAllowed) {
          submitStatus.textContent = mismatchMessage || "Submit blocked (resolve mismatch/missing label)";
        } else if (c.state === "submitted" && (savedPath || prefixHint)) {
          submitStatus.textContent = `Saved: ${savedPath || prefixHint}`;
        } else {
          submitStatus.textContent = "Capture must succeed before submit.";
        }

        const cooldownUntil = Number(c.cooldown_until || 0);
        if (cooldownUntil && data.server_time) {
          const remaining = Math.max(0, Math.round(cooldownUntil - data.server_time));
          const mm = Math.floor(remaining / 60);
          const ss = String(remaining % 60).padStart(2, "0");
          submitStatus.textContent += ` | Tag cooldown ${mm}:${ss}`;
        }

        const captureTimeIso = c.number_time_iso || c.started_time_iso || "";
        const captureCaption = captureTimeIso ? `Captured at ${captureTimeIso}` : "";
        const attemptCaption = attempt ? `Attempt ${attempt}` : "";

        if (includeImages) {
          imgOriginal.src = c.original_b64 ? "data:image/jpeg;base64," + c.original_b64 : "";
          imgPaper.src = c.paper_b64 ? "data:image/jpeg;base64," + c.paper_b64 : "";
          imgSecondary.src = c.secondary_b64 ? "data:image/jpeg;base64," + c.secondary_b64 : "";
          titleOriginal.textContent = "Original" + (attemptCaption ? ` â€¢ ${attemptCaption}` : "");
          titlePaper.textContent = "Warped paper" + (captureCaption ? ` â€¢ ${captureCaption}` : "");
          titleSecondary.textContent = "Secondary camera" + (c.secondary_message ? ` â€¢ ${c.secondary_message}` : "");
        } else {
          imgOriginal.src = "";
          imgPaper.src = "";
          imgSecondary.src = "";
          titleOriginal.textContent = "Original (outline)";
          titlePaper.textContent = "Warped paper";
          titleSecondary.textContent = "Secondary camera";
        }

        renderEvents(data.events || []);

        if (activeTab === "tags" && listenEnabled && r.enabled) {
          const tag = (r.last_tag || "").trim();
          const tagTime = Number(r.last_tag_time || 0);
          const tagApproved = !!r.last_tag_approved;
          const nowTs = Date.now() / 1000;

          const isNewer = tag && tagTime && tagTime > lastScannedTime;
          const debounceOk = !lastListenedTag || tag !== lastListenedTag || (nowTs - lastListenTs) > LISTEN_DEBOUNCE_SECONDS;
          if (tag && isNewer && debounceOk) {
            lastScannedTime = tagTime;
            lastListenedTag = tag;
            lastListenTs = nowTs;

            tagInput.value = tag;
            if (!tagLabelInput.value.trim()) {
              tagLabelInput.value = "";
            }
            tagsStatus.textContent = tagApproved ? `Tag detected (approved): ${tag}` : `Tag detected: ${tag}. Review and click Add Tag to save.`;
          }
        }
      } catch (e) {
        connDot.classList.remove("ok");
        connText.textContent = "Server: not reachable";
        listenBtn.disabled = true;
      } finally {
        pollInFlight = false;
      }
    }

    setListening(false);
    refreshTags();
    pollStatus();
    setInterval(pollStatus, 1000);
  </script>
</body>
</html>
